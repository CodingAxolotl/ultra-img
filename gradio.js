/**
 * Minified by jsDelivr using Terser v5.39.0.
 * Original file: /npm/@gradio/client@2.0.4/dist/index.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
const HOST_URL="host",SSE_URL="queue/data",SSE_DATA_URL="queue/join",UPLOAD_URL="upload",LOGIN_URL="login",CONFIG_URL="config",API_INFO_URL="info",RUNTIME_URL="runtime",SLEEPTIME_URL="sleeptime",HEARTBEAT_URL="heartbeat",COMPONENT_SERVER_URL="component_server",RESET_URL="reset",CANCEL_URL="cancel",APP_ID_URL="app_id",QUEUE_FULL_MSG="This application is currently busy. Please try again. ",BROKEN_CONNECTION_MSG="Connection errored out. ",CONFIG_ERROR_MSG="Could not resolve app config. ",SPACE_STATUS_ERROR_MSG="Could not get space status. ",API_INFO_ERROR_MSG="Could not get API info. ",SPACE_METADATA_ERROR_MSG="Space metadata could not be loaded. ",INVALID_URL_MSG="Invalid URL. A full URL path is required.",UNAUTHORIZED_MSG="Not authorized to access this space. ",INVALID_CREDENTIALS_MSG="Invalid credentials. Could not login. ",MISSING_CREDENTIALS_MSG="Login credentials are required to access this space.",NODEJS_FS_ERROR_MSG="File system access is only available in Node.js environments",ROOT_URL_ERROR_MSG="Root URL not found in client config",FILE_PROCESSING_ERROR_MSG="Error uploading file";async function get_jwt(e,t,n){try{const s=await fetch(`https://huggingface.co/api/spaces/${e}/jwt`,{headers:{Authorization:`Bearer ${t}`,...n?{Cookie:n}:{}}});return(await s.json()).token||!1}catch(e){return!1}}function map_names_to_ids(e){let t={};return e.forEach((({api_name:e,id:n})=>{e&&(t[e]=n)})),t}async function resolve_config(e){const t=this.options.token?{Authorization:`Bearer ${this.options.token}`}:{};if(t["Content-Type"]="application/json","undefined"!=typeof window&&window.gradio_config&&"http://localhost:9876"!==location.origin){if(window.gradio_config.current_page&&(e=e.substring(0,e.lastIndexOf("/"))),window.gradio_config.dev_mode||"undefined"!=typeof window&&"dev"===window?.BUILD_MODE){let n=join_urls(e,this.deep_link?"config?deep_link="+this.deep_link:"config");const s=await this.fetch(n,{headers:t,credentials:"include"}),i=await handleConfigResponse(s,!!this.options.auth);i.root=e||i.root,window.gradio_config={...i,current_page:window.gradio_config.current_page}}return{...window.gradio_config}}if(e){let n=join_urls(e,this.deep_link?"config?deep_link="+this.deep_link:"config");const s=await this.fetch(n,{headers:t,credentials:"include"}),i=await handleConfigResponse(s,!!this.options.auth);return i.root||(i.root=e),i}throw new Error(CONFIG_ERROR_MSG)}async function handleConfigResponse(e,t){if(401===e?.status&&!t){const t=await e.json(),n=t?.detail?.auth_message;throw new Error(n||MISSING_CREDENTIALS_MSG)}if(401===e?.status&&t)throw new Error(INVALID_CREDENTIALS_MSG);if(200===e?.status){let t=await e.json();return t.dependencies?.forEach(((e,t)=>{void 0===e.id&&(e.id=t)})),t}if(401===e?.status)throw new Error(UNAUTHORIZED_MSG);throw new Error(CONFIG_ERROR_MSG)}async function resolve_cookies(){const{http_protocol:e,host:t}=await process_endpoint(this.app_reference,this.options.token);try{if(this.options.auth){const n=await get_cookie_header(e,t,this.options.auth,this.fetch,this.options.token);n&&this.set_cookies(n)}}catch(e){throw Error(e.message)}}async function get_cookie_header(e,t,n,s,i){const a=new FormData;a.append("username",n?.[0]),a.append("password",n?.[1]);let o={};i&&(o.Authorization=`Bearer ${i}`);const r=await s(`${e}//${t}/login`,{headers:o,method:"POST",body:a,credentials:"include"});if(200===r.status)return r.headers.get("set-cookie");throw 401===r.status?new Error(INVALID_CREDENTIALS_MSG):new Error(SPACE_METADATA_ERROR_MSG)}function determine_protocol(e){if(e.startsWith("http")){const{protocol:t,host:n,pathname:s}=new URL(e);return{ws_protocol:"https:"===t?"wss":"ws",http_protocol:t,host:n+("/"!==s?s:"")}}return{ws_protocol:"wss",http_protocol:"https:",host:new URL(e).host}}const parse_and_set_cookies=e=>{let t=[];return e.split(/,(?=\s*[^\s=;]+=[^\s=;]+)/).forEach((e=>{const[n,s]=e.split(";")[0].split("=");n&&s&&t.push(`${n.trim()}=${s.trim()}`)})),t},RE_SPACE_NAME=/^[a-zA-Z0-9_\-\.]+\/[a-zA-Z0-9_\-\.]+$/,RE_SPACE_DOMAIN=/.*hf\.space\/{0,1}.*$/;async function process_endpoint(e,t){const n={};t&&(n.Authorization=`Bearer ${t}`);const s=e.trim().replace(/\/$/,"");if(RE_SPACE_NAME.test(s))try{const t=await fetch(`https://huggingface.co/api/spaces/${s}/host`,{headers:n});return{space_id:e,...determine_protocol((await t.json()).host)}}catch(e){throw new Error(SPACE_METADATA_ERROR_MSG)}if(RE_SPACE_DOMAIN.test(s)){const{ws_protocol:e,http_protocol:t,host:n}=determine_protocol(s);return{space_id:n.split("/")[0].replace(".hf.space",""),ws_protocol:e,http_protocol:t,host:n}}return{space_id:!1,...determine_protocol(s)}}const join_urls=(...e)=>{try{return e.reduce(((e,t)=>(e=e.replace(/\/+$/,""),t=t.replace(/^\/+/,""),new URL(t,e+"/").toString())))}catch(e){throw new Error(INVALID_URL_MSG)}};function transform_api_info(e,t,n){const s={named_endpoints:{},unnamed_endpoints:{}};return Object.keys(e).forEach((i=>{"named_endpoints"!==i&&"unnamed_endpoints"!==i||(s[i]={},Object.entries(e[i]).forEach((([e,{parameters:a,returns:o}])=>{const r=t.dependencies.find((t=>t.api_name===e||t.api_name===e.replace("/","")))?.id||n[e.replace("/","")]||-1,c=-1!==r?t.dependencies.find((e=>e.id==r))?.types:{generator:!1,cancel:!1};if(-1!==r&&t.dependencies.find((e=>e.id==r))?.inputs?.length!==a.length){const e=t.dependencies.find((e=>e.id==r)).inputs.map((e=>t.components.find((t=>t.id===e))?.type));try{e.forEach(((e,t)=>{if("state"===e){const e={component:"state",example:null,parameter_default:null,parameter_has_default:!0,parameter_name:null,hidden:!0};a.splice(t,0,e)}}))}catch(e){console.error(e)}}const p=(e,t,n,s)=>({...e,description:get_description(e?.type,n),type:get_type(e?.type,t,n,s)||""});s[i][e]={parameters:a.map((e=>p(e,e?.component,e?.serializer,"parameter"))),returns:o.map((e=>p(e,e?.component,e?.serializer,"return"))),type:c}})))})),s}function get_type(e,t,n,s){if("Api"===t)return e.type;switch(e?.type){case"string":return"string";case"boolean":return"boolean";case"number":return"number"}return"JSONSerializable"===n||"StringSerializable"===n?"any":"ListStringSerializable"===n?"string[]":"Image"===t?"parameter"===s?"Blob | File | Buffer":"string":"FileSerializable"===n?"array"===e?.type?"parameter"===s?"(Blob | File | Buffer)[]":"{ name: string; data: string; size?: number; is_file?: boolean; orig_name?: string}[]":"parameter"===s?"Blob | File | Buffer":"{ name: string; data: string; size?: number; is_file?: boolean; orig_name?: string}":"GallerySerializable"===n?"parameter"===s?"[(Blob | File | Buffer), (string | null)][]":"[{ name: string; data: string; size?: number; is_file?: boolean; orig_name?: string}, (string | null))][]":void 0}function get_description(e,t){return"GallerySerializable"===t?"array of [file, label] tuples":"ListStringSerializable"===t?"array of strings":"FileSerializable"===t?"array of files or single file":e?.description}function handle_message(e,t){const n=!0;switch(e.msg){case"send_data":return{type:"data"};case"send_hash":return{type:"hash"};case"queue_full":return{type:"update",status:{queue:n,message:QUEUE_FULL_MSG,stage:"error",code:e.code,success:e.success}};case"heartbeat":return{type:"heartbeat"};case"unexpected_error":return{type:"unexpected_error",status:{queue:n,message:e.message,session_not_found:e.session_not_found,stage:"error",success:!1}};case"broken_connection":return{type:"broken_connection",status:{queue:n,message:e.message,stage:"error",success:!1}};case"estimation":return{type:"update",status:{queue:n,stage:t||"pending",code:e.code,size:e.queue_size,position:e.rank,eta:e.rank_eta,success:e.success}};case"progress":return{type:"update",status:{queue:n,stage:"pending",code:e.code,progress_data:e.progress_data,success:e.success}};case"log":return{type:"log",data:e};case"process_generating":return{type:"generating",status:{queue:n,message:e.success?null:e.output.error,stage:e.success?"generating":"error",code:e.code,progress_data:e.progress_data,eta:e.average_duration,changed_state_ids:e.success?e.output.changed_state_ids:void 0},data:e.success?e.output:null};case"process_streaming":return{type:"streaming",status:{queue:n,message:e.output.error,stage:"streaming",time_limit:e.time_limit,code:e.code,progress_data:e.progress_data,eta:e.eta},data:e.output};case"process_completed":return"error"in e.output?{type:"update",status:{queue:n,title:e.output.title??"Error",message:e.output.error??"An error occurred",visible:e.output.visible,duration:e.output.duration,stage:"error",code:e.code,success:e.success}}:{type:"complete",status:{queue:n,message:e.success?void 0:e.output.error,stage:e.success?"complete":"error",code:e.code,progress_data:e.progress_data,changed_state_ids:e.success?e.output.changed_state_ids:void 0},data:e.success?e.output:null};case"process_starts":return{type:"update",status:{queue:n,stage:"pending",code:e.code,size:e.rank,position:0,success:e.success,eta:e.eta},original_msg:"process_starts"}}return{type:"none",status:{stage:"error",queue:n}}}const map_data_to_params=(e=[],t)=>{const n=t?t.parameters:[];if(Array.isArray(e))return t&&n.length>0&&e.length>n.length&&console.warn("Too many arguments provided for the endpoint."),e;const s=[],i=Object.keys(e);return n.forEach(((t,n)=>{if(e.hasOwnProperty(t.parameter_name))s[n]=e[t.parameter_name];else{if(!t.parameter_has_default)throw new Error(`No value provided for required parameter: ${t.parameter_name}`);s[n]=t.parameter_default}})),i.forEach((e=>{if(!n.some((t=>t.parameter_name===e)))throw new Error(`Parameter \`${e}\` is not a valid keyword argument. Please refer to the API for usage.`)})),s.forEach(((e,t)=>{if(void 0===e&&!n[t].parameter_has_default)throw new Error(`No value provided for required parameter: ${n[t].parameter_name}`)})),s};async function view_api(){if(this.api_info)return this.api_info;const{token:e}=this.options,{config:t}=this,n={"Content-Type":"application/json"};if(e&&(n.Authorization=`Bearer ${e}`),t)try{let e,s;if("undefined"!=typeof window&&window.gradio_api_info)s=window.gradio_api_info;else{const i=join_urls(t.root,this.api_prefix,"info");if(e=await this.fetch(i,{headers:n,credentials:"include"}),!e.ok)throw new Error(BROKEN_CONNECTION_MSG);s=await e.json()}return"api"in s&&(s=s.api),s.named_endpoints["/predict"]&&!s.unnamed_endpoints[0]&&(s.unnamed_endpoints[0]=s.named_endpoints["/predict"]),transform_api_info(s,t,this.api_map)}catch(e){throw new Error("Could not get API info. "+e.message)}}async function upload_files(e,t,n){const s={};this?.options?.token&&(s.Authorization=`Bearer ${this.options.token}`);const i=[];let a;for(let o=0;o<t.length;o+=1e3){const r=t.slice(o,o+1e3),c=new FormData;r.forEach((e=>{c.append("files",e)}));try{const t=n?`${e}${this.api_prefix}/upload?upload_id=${n}`:`${e}${this.api_prefix}/upload`;a=await this.fetch(t,{method:"POST",body:c,headers:s,credentials:"include"})}catch(e){throw new Error(BROKEN_CONNECTION_MSG+e.message)}if(!a.ok){const e=await a.text();return{error:`HTTP ${a.status}: ${e}`}}const p=await a.json();p&&i.push(...p)}return{files:i}}const si={radix:1e3,unit:["b","kb","Mb","Gb","Tb","Pb","Eb","Zb","Yb"]},iec={radix:1024,unit:["b","Kib","Mib","Gib","Tib","Pib","Eib","Zib","Yib"]},jedec={radix:1024,unit:["b","Kb","Mb","Gb","Tb","Pb","Eb","Zb","Yb"]},SPECS={si:si,iec:iec,jedec:jedec};function filesize(e,t=1,n="jedec"){e=Math.abs(e);const{radix:s,unit:i}=SPECS[n]||SPECS.jedec;let a=0;for(;e>=s;)e/=s,++a;return`${e.toFixed(t)} ${i[a]}`}async function upload(e,t,n,s){let i=(Array.isArray(e)?e:[e]).map((e=>e.blob));const a=i.filter((e=>e.size>(s??1/0)));if(a.length)throw new Error(`File(s) exceed the maximum allowed size of ${filesize(s||1/0)}: ${a.map((e=>`"${e.name}"`)).join(", ")}`);return await Promise.all(await this.upload_files(t,i,n).then((async n=>{if(n.error)throw new Error(n.error);return n.files?n.files.map(((n,s)=>new FileData({...e[s],path:n,url:`${t}${this.api_prefix}/file=${n}`}))):[]})))}async function prepare_files(e,t){return e.map((e=>new FileData({path:e.name,orig_name:e.name,blob:e,size:e.size,mime_type:e.type,is_stream:t})))}class FileData{path;url;orig_name;size;blob;is_stream;mime_type;alt_text;b64;meta={_type:"gradio.FileData"};constructor({path:e,url:t,orig_name:n,size:s,blob:i,is_stream:a,mime_type:o,alt_text:r,b64:c}){this.path=e,this.url=t,this.orig_name=n,this.size=s,this.blob=t?void 0:i,this.is_stream=a,this.mime_type=o,this.alt_text=r,this.b64=c}}class Command{type;command;meta;fileData;constructor(e,t){this.type="command",this.command=e,this.meta=t}}const is_node="undefined"!=typeof process&&process.versions&&process.versions.node;function update_object(e,t,n){for(;n.length>1;){const t=n.shift();if("string"!=typeof t&&"number"!=typeof t)throw new Error("Invalid key type");e=e[t]}const s=n.shift();if("string"!=typeof s&&"number"!=typeof s)throw new Error("Invalid key type");e[s]=t}async function walk_and_store_blobs(e,t=void 0,n=[],s=!1,i=void 0){if(Array.isArray(e)){let a=[];return await Promise.all(e.map((async(o,r)=>{let c=n.slice();c.push(String(r));const p=await walk_and_store_blobs(e[r],s?i?.parameters[r]?.component||void 0:t,c,!1,i);a=a.concat(p)}))),a}if(globalThis.Buffer&&e instanceof globalThis.Buffer||e instanceof Blob)return[{path:n,blob:new Blob([e]),type:t}];if("object"==typeof e&&null!==e){let t=[];for(const s of Object.keys(e)){const a=[...n,s],o=e[s];t=t.concat(await walk_and_store_blobs(o,void 0,a,!1,i))}return t}return[]}function skip_queue(e,t){let n=t?.dependencies?.find((t=>t.id==e))?.queue;return null!=n?!n:!t.enable_queue}function post_message(e,t){return new Promise(((n,s)=>{const i=new MessageChannel;i.port1.onmessage=({data:e})=>{i.port1.close(),n(e)},window.parent.postMessage(e,t,[i.port2])}))}function handle_file(e){if("string"==typeof e){if(e.startsWith("http://")||e.startsWith("https://"))return{path:e,url:e,orig_name:e.split("/").pop()??"unknown",meta:{_type:"gradio.FileData"}};if(is_node)return new Command("upload_file",{path:e,name:e,orig_path:e})}else{if("undefined"!=typeof File&&e instanceof File)return new Blob([e]);if(e instanceof Buffer)return new Blob([e]);if(e instanceof Blob)return e}throw new Error("Invalid input: must be a URL, File, Blob, or Buffer object.")}function handle_payload(e,t,n,s,i=!1){if("input"===s&&!i)throw new Error("Invalid code path. Cannot skip state inputs for input.");if("output"===s&&i)return e;let a=[],o=0;const r="input"===s?t.inputs:t.outputs;for(let t=0;t<r.length;t++){const s=r[t],c=n.find((e=>e.id===s));if("state"!==c?.type){const t=e[o];a.push(t),o++}else{if(!i){o++;continue}if(e.length===r.length){const t=e[o];a.push(t),o++}else a.push(null)}}return a}async function handle_blob(e,t,n){const s=this;await process_local_file_commands(s,t);const i=await walk_and_store_blobs(t,void 0,[],!0,n);return(await Promise.all(i.map((async({path:t,blob:n,type:i})=>{if(!n)return{path:t,type:i};const a=await s.upload_files(e,[n]);return{path:t,file_url:a.files&&a.files[0],type:i,name:"undefined"!=typeof File&&n instanceof File?n?.name:void 0}})))).forEach((({path:e,file_url:n,type:s,name:i})=>{if("Gallery"===s)update_object(t,n,e);else if(n){const s=new FileData({path:n,orig_name:i});update_object(t,s,e)}})),t}async function process_local_file_commands(e,t){if(!(e.config?.root||e.config?.root_url))throw new Error(ROOT_URL_ERROR_MSG);await recursively_process_commands(e,t)}async function recursively_process_commands(e,t,n=[]){for(const s in t)t[s]instanceof Command?await process_single_command(e,t,s):"object"==typeof t[s]&&null!==t[s]&&await recursively_process_commands(e,t[s],[...n,s])}async function process_single_command(e,t,n){let s=t[n];const i=e.config?.root||e.config?.root_url;if(!i)throw new Error(ROOT_URL_ERROR_MSG);try{let a,o;if("undefined"==typeof process||!process.versions||!process.versions.node)throw new Error(NODEJS_FS_ERROR_MSG);{const e=await import("fs/promises");o=(await import("path")).resolve(process.cwd(),s.meta.path),a=await e.readFile(o)}const r=new Blob([a],{type:"application/octet-stream"}),c=await e.upload_files(i,[r]),p=c.files&&c.files[0];if(p){const e=new FileData({path:p,orig_name:s.meta.name||""});t[n]=e}}catch(e){console.error("Error uploading file",e)}}async function post_data(e,t,n){const s={"Content-Type":"application/json"};this.options.token&&(s.Authorization=`Bearer ${this.options.token}`);try{var i=await this.fetch(e,{method:"POST",body:JSON.stringify(t),headers:{...s,...n},credentials:"include"})}catch(e){return[{error:BROKEN_CONNECTION_MSG},500]}let a,o;try{a=await i.json(),o=i.status}catch(e){a={error:`Could not parse server response: ${e}`},o=500}return[a,o]}async function predict(e,t={}){let n=!1,s=!1;if(!this.config)throw new Error("Could not resolve app config");if("number"==typeof e)this.config.dependencies.find((t=>t.id==e));else{const t=e.replace(/^\//,"");this.config.dependencies.find((e=>e.id==this.api_map[t]))}return new Promise((async(i,a)=>{const o=this.submit(e,t,null,null,!0);let r;for await(const e of o)"data"===e.type&&(s&&i(r),n=!0,r=e),"status"===e.type&&("error"===e.stage&&a(e),"complete"===e.stage&&(s=!0,n&&i(r)))}))}async function check_space_status(e,t,n){let s,i,a="subdomain"===t?`https://huggingface.co/api/spaces/by-subdomain/${e}`:`https://huggingface.co/api/spaces/${e}`;try{if(s=await fetch(a),i=s.status,200!==i)throw new Error;s=await s.json()}catch(e){return void n({status:"error",load_status:"error",message:SPACE_STATUS_ERROR_MSG,detail:"NOT_FOUND"})}if(!s||200!==i)return;const{runtime:{stage:o},id:r}=s;switch(o){case"STOPPED":case"SLEEPING":n({status:"sleeping",load_status:"pending",message:"Space is asleep. Waking it up...",detail:o}),setTimeout((()=>{check_space_status(e,t,n)}),1e3);break;case"PAUSED":n({status:"paused",load_status:"error",message:"This space has been paused by the author. If you would like to try this demo, consider duplicating the space.",detail:o,discussions_enabled:await discussions_enabled(r)});break;case"RUNNING":case"RUNNING_BUILDING":n({status:"running",load_status:"complete",message:"Space is running.",detail:o});break;case"BUILDING":n({status:"building",load_status:"pending",message:"Space is building...",detail:o}),setTimeout((()=>{check_space_status(e,t,n)}),1e3);break;case"APP_STARTING":n({status:"starting",load_status:"pending",message:"Space is starting...",detail:o}),setTimeout((()=>{check_space_status(e,t,n)}),1e3);break;default:n({status:"space_error",load_status:"error",message:"This space is experiencing an issue.",detail:o,discussions_enabled:await discussions_enabled(r)})}}const check_and_wake_space=async(e,t)=>{let n=0;return new Promise((s=>{check_space_status(e,RE_SPACE_NAME.test(e)?"space_name":"subdomain",(i=>{t(i),"running"===i.status||"error"===i.status||"paused"===i.status||"space_error"===i.status?s():"sleeping"!==i.status&&"building"!==i.status||(n<12?(n++,setTimeout((()=>{check_and_wake_space(e,t).then(s)}),5e3)):s())}))}))},RE_DISABLED_DISCUSSION=/^(?=[^]*\b[dD]iscussions{0,1}\b)(?=[^]*\b[dD]isabled\b)[^]*$/;async function discussions_enabled(e){try{const t=await fetch(`https://huggingface.co/api/spaces/${e}/discussions`,{method:"HEAD"}),n=t.headers.get("x-error-message");return!(!t.ok||n&&RE_DISABLED_DISCUSSION.test(n))}catch(e){return!1}}async function get_space_hardware(e,t){const n={};t&&(n.Authorization=`Bearer ${t}`);try{const t=await fetch(`https://huggingface.co/api/spaces/${e}/runtime`,{headers:n});if(200!==t.status)throw new Error("Space hardware could not be obtained.");const{hardware:s}=await t.json();return s.current}catch(e){throw new Error(e.message)}}async function set_space_timeout(e,t,n){const s={};n&&(s.Authorization=`Bearer ${n}`);const i={seconds:t};try{const t=await fetch(`https://huggingface.co/api/spaces/${e}/sleeptime`,{method:"POST",headers:{"Content-Type":"application/json",...s},body:JSON.stringify(i)});if(200!==t.status)throw new Error("Could not set sleep timeout on duplicated Space. Please visit *ADD HF LINK TO SETTINGS* to set a timeout manually to reduce billing charges.");return await t.json()}catch(e){throw new Error(e.message)}}const hardware_types=["cpu-basic","cpu-upgrade","cpu-xl","t4-small","t4-medium","a10g-small","a10g-large","a10g-largex2","a10g-largex4","a100-large","zero-a10g","h100","h100x8"];async function duplicate(e,t){const{token:n,private:s,hardware:i,timeout:a,auth:o}=t;if(i&&!hardware_types.includes(i))throw new Error(`Invalid hardware type provided. Valid types are: ${hardware_types.map((e=>`"${e}"`)).join(",")}.`);const{http_protocol:r,host:c}=await process_endpoint(e,n);let p=null;if(o){const e=await get_cookie_header(r,c,o,fetch);e&&(p=parse_and_set_cookies(e))}const d={Authorization:`Bearer ${n}`,"Content-Type":"application/json",...p?{Cookie:p.join("; ")}:{}},l=(await(await fetch("https://huggingface.co/api/whoami-v2",{headers:d})).json()).name,u=e.split("/")[1],_={repository:`${l}/${u}`};let h;s&&(_.private=!0);try{i||(h=await get_space_hardware(e,n))}catch(e){throw Error(SPACE_METADATA_ERROR_MSG+e.message)}const f=i||h||"cpu-basic";_.hardware=f;try{const s=await fetch(`https://huggingface.co/api/spaces/${e}/duplicate`,{method:"POST",headers:d,body:JSON.stringify(_)});if(409===s.status)try{return await Client.connect(`${l}/${u}`,t)}catch(e){throw console.error("Failed to connect Client instance:",e),e}else if(200!==s.status)throw new Error(s.statusText);const i=await s.json();return await set_space_timeout(`${l}/${u}`,a||300,n),await Client.connect(get_space_reference(i.url),t)}catch(e){throw new Error(e)}}function get_space_reference(e){const t=e.match(/https:\/\/huggingface.co\/spaces\/([^/]+\/[^/]+)/);if(t)return t[1]}class TextLineStream extends TransformStream{#e="";constructor(e={allowCR:!1}){super({transform:(t,n)=>{for(t=this.#e+t;;){const s=t.indexOf("\n"),i=e.allowCR?t.indexOf("\r"):-1;if(-1!==i&&i!==t.length-1&&(-1===s||s-1>i)){n.enqueue(t.slice(0,i)),t=t.slice(i+1);continue}if(-1===s)break;const a="\r"===t[s-1]?s-1:s;n.enqueue(t.slice(0,a)),t=t.slice(s+1)}this.#e=t},flush:t=>{if(""===this.#e)return;const n=e.allowCR&&this.#e.endsWith("\r")?this.#e.slice(0,-1):this.#e;t.enqueue(n)}})}}function stream$1(e){let t=new TextDecoderStream,n=new TextLineStream({allowCR:!0});return e.pipeThrough(t).pipeThrough(n)}function split(e){let t=/[:]\s*/.exec(e),n=t&&t.index;if(n)return[e.substring(0,n),e.substring(n+t[0].length)]}function fallback(e,t,n){e.get(t)||e.set(t,n)}async function*events(e,t){if(!e.body)return;let n,s,i=stream$1(e.body).getReader();for(;;){if(t&&t.aborted)return i.cancel();if(n=await i.read(),n.done)return;if(!n.value){s&&(yield s),s=void 0;continue}let[e,a]=split(n.value)||[];"data"===e?(s||={},s[e]=s[e]?s[e]+"\n"+a:a):"event"===e?(s||={},s[e]=a):"id"===e?(s||={},s[e]=String(+a)===a?+a:a):"retry"===e&&(s||={},s[e]=+a||void 0)}}async function stream(e,t){let n=new Request(e,t);fallback(n.headers,"Accept","text/event-stream"),fallback(n.headers,"Content-Type","application/json");let s=await fetch(n);if(!s.ok)throw s;return events(s,n.signal)}async function open_stream(){let{event_callbacks:e,unclosed_events:t,pending_stream_messages:n,stream_status:s,config:i,jwt:a}=this;const o=this;if(!i)throw new Error("Could not resolve app config");s.open=!0;let r=null,c=new URLSearchParams({session_hash:this.session_hash}).toString(),p=new URL(`${i.root}${this.api_prefix}/${SSE_URL}?${c}`);a&&p.searchParams.set("__sign",a),r=this.stream(p),r?(r.onmessage=async function(a){let r=JSON.parse(a.data);if("close_stream"===r.msg)return void close_stream(s,o.abort_controller);const c=r.event_id;if(c)if(e[c]&&i){"process_completed"===r.msg&&["sse","sse_v1","sse_v2","sse_v2.1","sse_v3"].includes(i.protocol)&&t.delete(c);let n=e[c];"undefined"!=typeof window&&"undefined"!=typeof document?setTimeout(n,0,r):n(r)}else n[c]||(n[c]=[]),n[c].push(r);else await Promise.all(Object.keys(e).map((t=>e[t](r))))},r.onerror=async function(t){console.error(t),await Promise.all(Object.keys(e).map((t=>e[t]({msg:"broken_connection",message:BROKEN_CONNECTION_MSG}))))}):console.warn("Cannot connect to SSE endpoint: "+p.toString())}function close_stream(e,t){e&&(e.open=!1,t?.abort())}function apply_diff_stream(e,t,n){!e[t]?(e[t]=[],n.data.forEach(((n,s)=>{e[t][s]=n}))):n.data.forEach(((s,i)=>{let a=apply_diff(e[t][i],s);e[t][i]=a,n.data[i]=a}))}function apply_diff(e,t){return t.forEach((([t,n,s])=>{e=apply_edit(e,n,t,s)})),e}function apply_edit(e,t,n,s){if(0===t.length){if("replace"===n)return s;if("append"===n)return e+s;throw new Error(`Unsupported action: ${n}`)}let i=e;for(let e=0;e<t.length-1;e++)i=i[t[e]];const a=t[t.length-1];switch(n){case"replace":i[a]=s;break;case"append":i[a]+=s;break;case"add":Array.isArray(i)?i.splice(Number(a),0,s):i[a]=s;break;case"delete":Array.isArray(i)?i.splice(Number(a),1):delete i[a];break;default:throw new Error(`Unknown action: ${n}`)}return e}function readable_stream(e,t={}){const n={close:()=>{console.warn("Method not implemented.")},onerror:null,onmessage:null,onopen:null,readyState:0,url:e.toString(),withCredentials:!1,CONNECTING:0,OPEN:1,CLOSED:2,addEventListener:()=>{throw new Error("Method not implemented.")},dispatchEvent:()=>{throw new Error("Method not implemented.")},removeEventListener:()=>{throw new Error("Method not implemented.")}};return stream(e,t).then((async e=>{n.readyState=n.OPEN;try{for await(const t of e)n.onmessage&&n.onmessage(t);n.readyState=n.CLOSED}catch(e){n.onerror&&n.onerror(e),n.readyState=n.CLOSED}})).catch((e=>{console.error(e),n.onerror&&n.onerror(e),n.readyState=n.CLOSED})),n}function submit(e,t={},n,s,i,a){try{let r=function(e){(i||z[e.type])&&l(e)},c=function(){for(J=!0;W.length>0;)W.shift()({value:void 0,done:!0})},p=function(e){W.length>0?W.shift()(e):K.push(e)},d=function(e){p(thenable_reject(e)),c()},l=function(e){p({value:e,done:!1})},u=function(){return K.length>0?Promise.resolve(K.shift()):new Promise((e=>W.push(e)))};const{token:_}=this.options,{fetch:h,app_reference:f,config:g,session_hash:m,api_info:w,api_map:y,stream_status:b,pending_stream_messages:E,pending_diff_streams:S,event_callbacks:v,unclosed_events:R,post_data:k,options:O,api_prefix:N}=this,C=a||{"x-gradio-user":"api"},$=this;if(!w)throw new Error("No API found");if(!g)throw new Error("Could not resolve app config");let A,{fn_index:T,endpoint_info:x,dependency:I}=get_endpoint_info(w,e,y,g),L=map_data_to_params(t,x),D=g.protocol??"ws";if("ws"===D)throw new Error("WebSocket protocol is not supported in this version");let G="";const P="number"==typeof e?"/predict":e;let U,M=null,j=!1,F={},q="undefined"!=typeof window&&"undefined"!=typeof document?new URLSearchParams(window.location.search).toString():"";const z=O?.events?.reduce(((e,t)=>(e[t]=!0,e)),{})||{};const B=async e=>{await this._resolve_heartbeat(e)};async function o(e){if(!g)return;let t=e.render_id;g.components=[...g.components.filter((e=>e.props.rendered_in!==t)),...e.components],g.dependencies=[...g.dependencies.filter((e=>e.rendered_in!==t)),...e.dependencies];const n=g.components.some((e=>"state"===e.type)),s=g.dependencies.some((e=>e.targets.some((e=>"unload"===e[1]))));g.connect_heartbeat=n||s,await B(g),r({type:"render",data:e,endpoint:P,fn_index:T})}const H=this.handle_blob(g.root,L,x).then((async e=>{let t=handle_payload(e,I,g.components,"input",!0);if(U={data:t||[],event_data:n,fn_index:T,trigger_id:s},skip_queue(T,g))r({type:"status",endpoint:P,stage:"pending",queue:!1,fn_index:T,time:new Date}),k(`${g.root}${N}/run${P.startsWith("/")?P:`/${P}`}${q?"?"+q:""}`,{...U,session_hash:m},C).then((async([e,t])=>{const i=e.data;200==t?(r({type:"data",endpoint:P,fn_index:T,data:handle_payload(i,I,g.components,"output",O.with_null_state),time:new Date,event_data:n,trigger_id:s}),e.render_config&&await o(e.render_config),r({type:"status",endpoint:P,fn_index:T,stage:"complete",eta:e.average_duration,queue:!1,time:new Date})):r({type:"status",stage:"error",endpoint:P,fn_index:T,message:e.error,queue:!1,time:new Date})})).catch((e=>{r({type:"status",stage:"error",message:e.message,endpoint:P,fn_index:T,queue:!1,time:new Date})}));else if("sse"==D){r({type:"status",stage:"pending",queue:!0,endpoint:P,fn_index:T,time:new Date});var i=new URLSearchParams({fn_index:T.toString(),session_hash:m}).toString();let e=new URL(`${g.root}${N}/${SSE_URL}?${q?q+"&":""}${i}`);if(this.jwt&&e.searchParams.set("__sign",this.jwt),A=this.stream(e),!A)return Promise.reject(new Error("Cannot connect to SSE endpoint: "+e.toString()));A.onmessage=async function(e){const t=JSON.parse(e.data),{type:i,status:a,data:o}=handle_message(t,F[T]);if("update"===i&&a&&!j)r({type:"status",endpoint:P,fn_index:T,time:new Date,...a}),"error"===a.stage&&(A?.close(),c());else if("data"===i){let[e,t]=await k(`${g.root}${N}/queue/data`,{...U,session_hash:m,event_id:M});200!==t&&(r({type:"status",stage:"error",message:BROKEN_CONNECTION_MSG,queue:!0,endpoint:P,fn_index:T,time:new Date}),A?.close(),c())}else"complete"===i?j=a:"log"===i?r({type:"log",title:o.title,log:o.log,level:o.level,endpoint:P,duration:o.duration,visible:o.visible,fn_index:T}):"generating"!==i&&"streaming"!==i||r({type:"status",time:new Date,...a,stage:a?.stage,queue:!0,endpoint:P,fn_index:T});o&&(r({type:"data",time:new Date,data:handle_payload(o.data,I,g.components,"output",O.with_null_state),endpoint:P,fn_index:T,event_data:n,trigger_id:s}),j&&(r({type:"status",time:new Date,...j,stage:a?.stage,queue:!0,endpoint:P,fn_index:T}),A?.close(),c()))}}else if("sse_v1"==D||"sse_v2"==D||"sse_v2.1"==D||"sse_v3"==D){r({type:"status",stage:"pending",queue:!0,endpoint:P,fn_index:T,time:new Date});let e="";"undefined"!=typeof window&&"undefined"!=typeof document&&(e=window?.location?.hostname);let t="dev.spaces.huggingface.tech";const n=e.includes(".dev.")?`https://moon-${e.split(".")[1]}.${t}`:"https://huggingface.co";return("undefined"!=typeof window&&"undefined"!=typeof document&&window.parent!=window&&window.supports_zerogpu_headers?post_message("zerogpu-headers",n):Promise.resolve(null)).then((e=>{const t={...C,...e||{}};return k(`${g.root}${N}/queue/join?${q}`,{...U,session_hash:m},t)})).then((async([e,t])=>{if(e.event_id&&(G=e.event_id),503===t)r({type:"status",stage:"error",message:QUEUE_FULL_MSG,queue:!0,endpoint:P,fn_index:T,time:new Date,visible:!0});else if(422===t)r({type:"status",stage:"error",message:e.detail,queue:!0,endpoint:P,fn_index:T,code:"validation_error",time:new Date,visible:!0}),c();else if(200!==t)r({type:"status",stage:"error",broken:!1,message:e.detail,queue:!0,endpoint:P,fn_index:T,time:new Date,visible:!0});else{M=e.event_id,G=M;let t=async function(e){try{const{type:t,status:n,data:s,original_msg:i}=handle_message(e,F[T]);if("heartbeat"==t)return;if("update"===t&&n&&!j)r({type:"status",endpoint:P,fn_index:T,time:new Date,original_msg:i,...n});else if("complete"===t)j=n;else if("unexpected_error"==t||"broken_connection"==t){console.error("Unexpected error",n?.message);const e="broken_connection"===t;r({type:"status",stage:"error",message:n?.message||"An Unexpected Error Occurred!",queue:!0,endpoint:P,broken:e,session_not_found:n?.session_not_found,fn_index:T,time:new Date})}else{if("log"===t)return void r({type:"log",title:s.title,log:s.log,level:s.level,endpoint:P,duration:s.duration,visible:s.visible,fn_index:T});"generating"!==t&&"streaming"!==t||(r({type:"status",time:new Date,...n,stage:n?.stage,queue:!0,endpoint:P,fn_index:T}),s&&"stream"!==I.connection&&["sse_v2","sse_v2.1","sse_v3"].includes(D)&&apply_diff_stream(S,M,s))}s&&(r({type:"data",time:new Date,data:handle_payload(s.data,I,g.components,"output",O.with_null_state),endpoint:P,fn_index:T}),s.render_config&&await o(s.render_config),j&&(r({type:"status",time:new Date,...j,stage:n?.stage,queue:!0,endpoint:P,fn_index:T}),c())),"complete"!==n?.stage&&"error"!==n?.stage||(v[M]&&delete v[M],M in S&&delete S[M])}catch(e){console.error("Unexpected client exception",e),r({type:"status",stage:"error",message:"An Unexpected Error Occurred!",queue:!0,endpoint:P,fn_index:T,time:new Date}),["sse_v2","sse_v2.1","sse_v3"].includes(D)&&(close_stream(b,$.abort_controller),b.open=!1,c())}};M in E&&(E[M].forEach((e=>t(e))),delete E[M]),v[M]=t,R.add(M),b.open||await this.open_stream()}}))}}));let J=!1;const K=[],W=[],V={[Symbol.asyncIterator]:()=>V,next:u,throw:async e=>(d(e),u()),return:async()=>(c(),{value:void 0,done:!0}),cancel:async function(){let e={},t={};e={event_id:M},t={event_id:M,session_hash:m,fn_index:T};try{if(!g)throw new Error("Could not resolve app config");"event_id"in t&&await h(`${g.root}${N}/cancel`,{headers:{"Content-Type":"application/json"},method:"POST",body:JSON.stringify(t)}),await h(`${g.root}${N}/reset`,{headers:{"Content-Type":"application/json"},method:"POST",body:JSON.stringify(e)})}catch(e){console.warn("The `/reset` endpoint could not be called. Subsequent endpoint results may be unreliable.")}},send_chunk:e=>{this.post_data(`${g.root}${N}/stream/${G}`,{...e,session_hash:this.session_hash})},close_stream:()=>{this.post_data(`${g.root}${N}/stream/${G}/close`,{}),c()},event_id:()=>G,wait_for_id:async()=>(await H,M)};return V}catch(Z){throw console.error("Submit function encountered an error:",Z),Z}}function thenable_reject(e){return{then:(t,n)=>n(e)}}function get_endpoint_info(e,t,n,s){let i,a,o;if("number"==typeof t)i=t,a=e.unnamed_endpoints[i],o=s.dependencies.find((e=>e.id==t));else{const r=t.replace(/^\//,"");i=n[r],a=e.named_endpoints[t.trim()],o=s.dependencies.find((e=>e.id==n[r]))}if("number"!=typeof i)throw new Error("There is no endpoint matching that name of fn_index matching that number.");return{fn_index:i,endpoint_info:a,dependency:o}}class Client{app_reference;options;deep_link=null;config;api_prefix="";api_info;api_map={};session_hash=Math.random().toString(36).substring(2);jwt=!1;last_status={};cookies=null;stream_status={open:!1};closed=!1;pending_stream_messages={};pending_diff_streams={};event_callbacks={};unclosed_events=new Set;heartbeat_event=null;abort_controller=null;stream_instance=null;current_payload;get_url_config(e=null){if(!this.config)throw new Error(CONFIG_ERROR_MSG);null===e&&(e=window.location.href);const t=e=>e.replace(/^\/+|\/+$/g,"");let n,s=t(new URL(this.config.root).pathname),i=t(new URL(e).pathname);return n=i.startsWith(s)?t(i.substring(s.length)):"",this.get_page_config(n)}get_page_config(e){if(!this.config)throw new Error(CONFIG_ERROR_MSG);let t=this.config;return e in t.page||(e=""),{...t,current_page:e,layout:t.page[e].layout,components:t.components.filter((n=>t.page[e].components.includes(n.id))),dependencies:this.config.dependencies.filter((n=>t.page[e].dependencies.includes(n.id)))}}fetch(e,t){const n=new Headers(t?.headers||{});if(this&&this.cookies&&n.append("Cookie",this.cookies),this&&this.options.headers){new Headers(this.options.headers).forEach(((e,t)=>{n.append(t,e)}))}return fetch(e,{...t,headers:n})}stream(e){const t=new Headers;if(this&&this.cookies&&t.append("Cookie",this.cookies),this&&this.options.headers){new Headers(this.options.headers).forEach(((e,n)=>{t.append(n,e)}))}return this&&this.options.token&&t.append("Authorization",`Bearer ${this.options.token}`),this.abort_controller=new AbortController,this.stream_instance=readable_stream(e.toString(),{credentials:"include",headers:t,signal:this.abort_controller.signal}),this.stream_instance}view_api;upload_files;upload;handle_blob;post_data;submit;predict;open_stream;resolve_config;resolve_cookies;constructor(e,t={events:["data"]}){this.app_reference=e,this.deep_link=t.query_params?.deep_link||null,t.events||(t.events=["data"]),this.options=t,this.current_payload={},t.cookies&&(this.cookies=t.cookies),this.view_api=view_api.bind(this),this.upload_files=upload_files.bind(this),this.handle_blob=handle_blob.bind(this),this.post_data=post_data.bind(this),this.submit=submit.bind(this),this.predict=predict.bind(this),this.open_stream=open_stream.bind(this),this.resolve_config=resolve_config.bind(this),this.resolve_cookies=resolve_cookies.bind(this),this.upload=upload.bind(this),this.fetch=this.fetch.bind(this),this.handle_space_success=this.handle_space_success.bind(this),this.stream=this.stream.bind(this)}async init(){this.options.auth&&await this.resolve_cookies(),await this._resolve_config().then((({config:e})=>this._resolve_heartbeat(e))),this.api_info=await this.view_api(),this.api_map=map_names_to_ids(this.config?.dependencies||[])}async _resolve_heartbeat(e){if(e&&(this.config=e,this.api_prefix=e.api_prefix||"",this.config&&this.config.connect_heartbeat&&this.config.space_id&&this.options.token&&(this.jwt=await get_jwt(this.config.space_id,this.options.token,this.cookies))),e.space_id&&this.options.token&&(this.jwt=await get_jwt(e.space_id,this.options.token)),this.config&&this.config.connect_heartbeat){const e=new URL(`${this.config.root}${this.api_prefix}/heartbeat/${this.session_hash}`);this.jwt&&e.searchParams.set("__sign",this.jwt),this.heartbeat_event||(this.heartbeat_event=this.stream(e))}}static async connect(e,t={events:["data"]}){const n=new this(e,t);return t.session_hash&&(n.session_hash=t.session_hash),await n.init(),n}async reconnect(){const e=new URL(`${this.config.root}${this.api_prefix}/app_id`);let t;try{const n=await this.fetch(e);if(!n.ok)throw new Error;t=(await n.json()).app_id}catch(e){return"broken"}return t!==this.config.app_id?"changed":"connected"}close(){this.closed=!0,close_stream(this.stream_status,this.abort_controller)}set_current_payload(e){this.current_payload=e}static async duplicate(e,t={events:["data"]}){return duplicate(e,t)}async _resolve_config(){const{http_protocol:e,host:t,space_id:n}=await process_endpoint(this.app_reference,this.options.token),{status_callback:s}=this.options;let i;n&&s&&await check_and_wake_space(n,s);try{let n=`${e}//${t}`;if(i=await this.resolve_config(n),!i)throw new Error(CONFIG_ERROR_MSG);return this.config_success(i)}catch(e){if(!n||!s)throw s&&s({status:"error",message:"Could not load this space.",load_status:"error",detail:"NOT_FOUND"}),Error(e);check_space_status(n,RE_SPACE_NAME.test(n)?"space_name":"subdomain",this.handle_space_success)}}async config_success(e){if(this.config=e,this.api_prefix=e.api_prefix||"",this.config.auth_required)return this.prepare_return_obj();try{this.api_info=await this.view_api()}catch(e){console.error(API_INFO_ERROR_MSG+e.message)}return this.prepare_return_obj()}async handle_space_success(e){if(!this)throw new Error(CONFIG_ERROR_MSG);const{status_callback:t}=this.options;if(t&&t(e),"running"===e.status)try{if(this.config=await this._resolve_config(),this.api_prefix=this?.config?.api_prefix||"",!this.config)throw new Error(CONFIG_ERROR_MSG);return await this.config_success(this.config)}catch(e){throw t&&t({status:"error",message:"Could not load this space.",load_status:"error",detail:"NOT_FOUND"}),e}}async component_server(e,t,n){if(!this.config)throw new Error(CONFIG_ERROR_MSG);const s={},{token:i}=this.options,{session_hash:a}=this;let o;i&&(s.Authorization=`Bearer ${this.options.token}`);let r,c=this.config.components.find((t=>t.id===e));if(o=c?.props?.root_url?c.props.root_url:this.config.root,"binary"in n){r=new FormData;for(const e in n.data)"binary"!==e&&r.append(e,n.data[e]);r.set("component_id",e.toString()),r.set("fn_name",t),r.set("session_hash",a)}else r=JSON.stringify({data:n,component_id:e,fn_name:t,session_hash:a}),s["Content-Type"]="application/json";i&&(s.Authorization=`Bearer ${i}`);try{const e=await this.fetch(`${o}${this.api_prefix}/component_server/`,{method:"POST",body:r,headers:s,credentials:"include"});if(!e.ok)throw new Error("Could not connect to component server: "+e.statusText);return await e.json()}catch(e){console.warn(e)}}set_cookies(e){this.cookies=parse_and_set_cookies(e).join("; ")}prepare_return_obj(){return{config:this.config,predict:this.predict,submit:this.submit,view_api:this.view_api,component_server:this.component_server}}}async function client(e,t={events:["data"]}){return await Client.connect(e,t)}async function duplicate_space(e,t){return await Client.duplicate(e,t)}export{Client,FileData,MISSING_CREDENTIALS_MSG,client,duplicate_space as duplicate,handle_file,predict,prepare_files,submit,upload,upload_files};
//# sourceMappingURL=/sm/efeeabfd27e818b6e371af43871b49af35d75e36537d357058b5ff25339d90b2.map